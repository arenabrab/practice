name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: barbanera/practice

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: Make gradlew executable
        working-directory: ./metrics
        run: chmod +x gradlew

      - name: Run tests
        working-directory: ./metrics
        run: ./gradlew test

  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure swap space
        run: |
          sudo fallocate -l 2G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '24'
          distribution: 'graalvm'
          native-image-job-reports: 'true'
          cache: 'gradle'

      - name: Setup Gradle with enhanced caching
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper
          cache-read-only: false
          gradle-home-cache-cleanup: true

      # Cache native image compilation artifacts
      - name: Cache GraalVM native image artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches/modules-2/files-2.1
            ~/.gradle/wrapper
            ./metrics/build/native/nativeCompile
            ./metrics/.gradle
          key: ${{ runner.os }}-graalvm-native-${{ hashFiles('**/build.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-graalvm-native-
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        working-directory: ./metrics
        run: chmod +x ./gradlew

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate image tag
        id: image-tag
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          SHORT_SHA=${GITHUB_SHA::7}
          IMAGE_TAG="${BRANCH_NAME}-${SHORT_SHA}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-buildx-${{ hashFiles('**/Dockerfile', '**/build.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-docker-buildx-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-flags: --debug
          driver-opts: |
            network=host

      # Optimized Native Compile with better configuration
      - name: Native Compile (Optimized)
        working-directory: ./metrics
        run: |
          # Pre-configure JVM options for optimal native compilation
          export JAVA_OPTS="-XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Xmx5g -XX:+UseStringDeduplication"
          
          # Run native compilation with optimized settings
          ./gradlew nativeCompile \
            --no-daemon \
            --parallel \
            --build-cache \
            -Pspring.aot.enabled=true \
            -Dorg.gradle.jvmargs="-Xmx10g -XX:MaxMetaspaceSize=2g -XX:+UseG1GC"
        env:
          GRADLE_OPTS: "-Xmx5g -XX:MaxMetaspaceSize=2g -XX:+UseG1GC -Dorg.gradle.daemon=false"
          # Native image specific optimizations
          NATIVE_IMAGE_OPTS: >-
            --no-fallback
            -J-Xmx5g
            -J-XX:+UseG1GC
            -H:+ReportExceptionStackTraces
            --enable-preview
            --parallelism=3
            -H:+AllowVMInspection
            -H:+UnlockExperimentalVMOptions
            -H:+UseCompressedOops
            -H:+UseCGroupMemoryLimitForHeap
            -H:ConfigurationFileDirectories=src/main/resources/META-INF/native-image/
            --initialize-at-run-time=ch.qos.logback.classic.util.LogbackMDCAdapter,ch.qos.logback.classic.spi.LogbackServiceProvider,ch.qos.logback,org.slf4j
            --initialize-at-build-time=org.springframework
            -H:ReflectionConfigurationFiles=reflect-config.json
            -H:ResourceConfigurationFiles=resource-config.json
            --trace-class-initialization=org.springframework

      - name: Build and push with bootBuildImage (Skip native compile)
        working-directory: ./metrics
        run: |
          ./gradlew bootBuildImage \
            -x test \
            -x nativeCompile \
            --no-daemon \
            --parallel \
            --build-cache \
            --imageName=${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }} \
            --publishImage
        env:
          DOCKER_REGISTRY_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_REGISTRY_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKER_BUILDKIT: 1
          # Optimized buildpack configuration
          BP_JVM_VERSION: "24"
          BPL_JVM_HEAD_ROOM: "10"
          BP_NATIVE_IMAGE: "true"
          BP_NATIVE_IMAGE_BUILD_ARGUMENTS: "--no-fallback -J-Xmx5g -J-XX:+UseG1GC -H:+ReportExceptionStackTraces --enable-preview --parallelism=3 -H:+AllowVMInspection -H:+UnlockExperimentalVMOptions --initialize-at-run-time=ch.qos.logback.classic.util.LogbackMDCAdapter,ch.qos.logback.classic.spi.LogbackServiceProvider,ch.qos.logback,org.slf4j --initialize-at-build-time=org.springframework"
          BP_GRADLE_BUILD_ARGUMENTS: "--no-daemon --parallel --build-cache --configuration-cache -Pspring.aot.enabled=true"
          MAVEN_OPTS: "-Xmx5g"
          GRADLE_OPTS: "-Xmx5g -XX:MaxMetaspaceSize=1g -XX:+UseG1GC"

      - name: Tag and push latest
        if: github.ref == 'refs/heads/master'
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }} ${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.IMAGE_NAME }}:latest

  update-gitops:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: arenabrab/practice-gitops
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops

      - name: Update image tag
        run: |
          cd gitops/clusters/local/apps/metrics
          NEW_TAG=${{ needs.build-and-push.outputs.image-tag }}
          sed -i "s/newTag:.*/newTag: ${NEW_TAG}/" kustomization.yaml

      - name: Commit and push changes
        run: |
          cd gitops
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add .
          git commit -m "Update image tag to ${{ needs.build-and-push.outputs.image-tag }}" || exit 0
          git push